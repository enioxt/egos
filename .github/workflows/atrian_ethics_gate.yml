# ETHICS-GATE-001: ATRiAN Ethics Evaluation Gate
# Auto-generated by Cascade on 2025-06-15

name: ATRiAN Ethics Evaluation

on:
  pull_request:
    paths:
      - '**.md'
      - '**.py'
      - 'docs/prompts/**'
  workflow_dispatch:

jobs:
  ethics-gate:
    runs-on: ubuntu-latest
    env:
      ATR_API_KEY: ${{ secrets.ATR_API_KEY }}
      ETHICAL_CONSTITUTION_ID: ${{ secrets.ETHICAL_CONSTITUTION_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ATRiAN SDK
        run: |
          pip install atrian-eaas-sdk

      - name: Extract changed files
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          echo "::set-output name=files::$(git diff --name-only origin/${{ github.base_ref }}..HEAD | tr '\n' ' ')"

      - name: Run ATRiAN ethics evaluation
        run: |
          python subsystems/ATRiAN/tools/run_ethics_evaluation.py --constitution-id "$ETHICAL_CONSTITUTION_ID" --files ${{ steps.diff.outputs.files }}

      - name: Check evaluation results
        run: |
          if [ -f atrian_evaluation_report.json ]; then
            violations=$(jq '.violations | length' atrian_evaluation_report.json)
            if [ "$violations" -gt 0 ]; then
              echo "Ethics gate failed with $violations violation(s). See atrian_evaluation_report.json for details.";
              exit 1; 
            fi
          else
            echo "ATRiAN evaluation report missing! Failing build."; exit 1;
          fi
